(function(){var d;d=window._G={Base:{noop:function(){},extend:function(j,b){j.prototype.__proto__=b.prototype;j.prototype.__super=b},plugin:function(j,b){if(!j.name&&!b)throw"Plugin must be named scope or have an id";d[b||j.name]=j},log:function(){typeof window.console!=="undefined"&&console.log([].slice.call(arguments).join("\t"))},keys:{N1:49,N2:50,N3:51,N4:52,N5:53,N6:54,N7:55,N8:56,T:84}}};window.require=function(j){var b=j.lastIndexOf("/"),c=j.substr(b+1,1);j=j.substr(b+2);c=c.toUpperCase()+
j;if(!d[c])throw"No such module"+c;return d[c]};window.module={exports:{}}})();(function(){function d(b,c){return[b,c]}var j=require("Base");d.sub=function(b,c){return[b[0]-c[0],b[1]-c[1]]};d.isVector=function(b){return b.length>1};d.toVector=function(b){return b.slice(0,2)};d.add=function(b,c){return[b[0]+c[0],b[1]+c[1]]};d.distSqrt=function(b,c){var g=[b[0]-c[0],b[1]-c[1]];return Math.sqrt(g[0]*g[0]+g[1]*g[1])};d.heading=function(b){return-Math.atan2(-b[1],b[0])};j.plugin(d)})();
(function(){function d(b,c){this.name=b;this.grid={};this.ent=[];this.cellSize=c}require("Vector");var j=require("Base");d.prototype._key=function(b){var c=this.cellSize;return Math.floor(b[1]/c)<<16^Math.floor(b[0]/c)};d.prototype._rawKey=function(b,c){var g=this.cellSize;return Math.floor(c/g)<<16^Math.floor(b/g)};d._fastKey=function(b,c,g){return Math.floor(c/g)<<16^Math.floor(b/g)};d.prototype.reset=function(){this.ent=[]};d.prototype.addShape=function(b){var c=b.data,g=c.length,i=b.origin;if(i){for(this.ent.push([i[0],
i[1],b.index,null]);g--;){var l=c[g];!l.length>1||this.ent.push([l[0]+i[0],l[1]+i[1],b.index,g])}for(g=(c=b.type.anchors)?c.length:0;g--;){l=c[g];this.ent.push([l[0]+i[0],l[1]+i[1],b.index,"anchor"])}}};d.prototype.addEntity=function(b,c){this.ent[b[2]]=b;c(null,b[2])};d.prototype.getEntity=function(b){return this.ent[b]};d.prototype.delEntity=function(b){delete this.ent[b]};d.prototype.getClosest=function(b){return this.grid[this._rawKey(b[0],b[1])]};d.prototype.getAreaKeys=function(b,c,g){(!b||
!c)&&g("No vector or distance supplied");var i=b[1]-c,l=b[0]+c,o=b[1]+c,a=this.cellSize,e=[],f=d._fastKey;for(b=b[0]-c;b<=l;b+=a)for(c=i;c<=o;c+=a){var k=f(b,c,a);e.push(k)}g(null,e)};d.prototype.getAreaIds=function(b,c,g){(!b||!c)&&g("No vector or distance supplied");var i=b[1]-c,l=b[0]+c,o=b[1]+c,a=this.cellSize,e=[],f=this.grid,k=d._fastKey;for(b=b[0]-c-1;b<=l+1;b+=a)for(c=i-1;c<=o+1;c+=a){var h=f[k(b,c,a)];if(h)for(var m=h.length;m--;){var n=h[m][2];e.indexOf(n)==-1&&e.push(n)}}g(null,e)};d.prototype.update=
function(){delete this.grid;this.grid={};for(var b=this.ent,c=this.grid,g=this.cellSize,i=d.addToGrid,l=b.length;l--;)i(b[l],c,g)};d.addToGrid=function(b,c,g){if(b&&c&&g){var i=b[0],l=b[1];co=[i-10,l-10,i+10,l-10,i-10,l+10,i+10,l+10];ec=[];rk=d._fastKey;for(i=0;i<8;i+=2){l=rk(co[i],co[i+1],g);if(ec.indexOf(l)==-1){ec.push(l);var o=c[l];o?o.push(b):c[l]=[b]}}}};j.plugin(d)})();
(function(){require("Base").plugin(function(d){this.type=d.type;this.index=d.count;this.data=[];this.origin=null;this.fillStyle=d.type.fillStyle;this.strokeStyle=d.type.strokeStyle;this.label="";this.state=d.state;this.children=[];this.parent=null})})();
(function(){function d(c){c=[c._x,c._y];this.tool.started||this.render();for(var g=this.grid.getClosest(c),i=g?g.length:0,l=[];i--;)if(g[i][3]=="anchor"){var o=b.distSqrt(g[i],c);l.push([o,g[i]])}return l.sort(function(a,e){return a[0]-e[0]})[0]}var j=require("Base"),b=require("Vector");j.plugin({anchorsUnderMouse:function(c){var g=this.tool,i=this.ctx;if((c=d.call(this,c))&&!g.started&&c[0]<30){g=c[1];i.beginPath();i.arc(g[0],g[1],3,0,Math.PI*2,!0);i.closePath();i.stroke()}},nearestAnchorVec:function(c){return d({_x:c[0],
_y:c[1]})},nearestAnchor:d,sample:function(c){var g=this.shapes,i=this.shapedata.count;g[i]&&g[i].data.push([c._x,c._y])}},"CommonTools")})();
(function(){function d(){this.started=!1}var j=require("Base");d.prototype={mousedown:function(b){var c=this.ctx;c.shadowBlur=1;c.strokeStyle="#000";c.lineWidth=2;c.beginPath();c.moveTo(b._x,b._y);this.tool.pencil.started=!0},mousemove:function(b){if(this.tool.pencil.started){var c=this.ctx;c.lineTo(b._x,b._y);c.stroke()}},mouseup:function(b){var c=this.tool.pencil;if(c.started){c.mousemove.call(this,b);c.started=!1}}};j.plugin(d)})();
(function(){function d(){}var j=require("Base"),b=require("Shape");d.prototype={mouseup:function(){},mousemove:function(){},mousedown:function(c){var g=new b(this.shapedata);g.origin=[c._x,c._y];this.shapes[this.shapedata.count]=g;this.shapedata.count++;this.shapedata.type.onCreate&&this.shapedata.type.onCreate.call(this,g);this.render()}};j.plugin(d)})();
(function(){function d(){this.started=!1;this.samplenext=!0;this.sample=b.sample;this.pencil=new c}var j=require("Base"),b=require("CommonTools"),c=require("Pencil"),g=require("Shape"),i=require("Vector"),l=b.anchorsUnderMouse,o=b.nearestAnchor;d.prototype={mousemove:function(a,e){e=this.tool;l.call(this,a);e.pencil.mousemove.call(this,a);if(e.samplenext&&e.started){e.sample.call(this,a);e.samplenext=!1;setTimeout(function(){e.samplenext=!0},30)}},mousedown:function(a){tool=this.tool;tool.started=
!0;tool.pencil.mousedown.call(this,a);var e=this.shapedata;this.shapes[e.count]=new g(e);a=o.call(this,a);tool.attachto=a&&a[0]<30?a[1]:null},mouseup:function(a,e){e=this.tool;e.pencil.mouseup.call(this,a);var f=this.shapes,k=this.shapedata;e.sample.call(this,a);if(e.started){e.started=!1;var h=f[k.count];if(h.data.length<5)delete f[k.count];else{var m;if(e.attachto){m=i.toVector(e.attachto);var n=h.parent=f[e.attachto[2]];h.data[0]=h.origin=m;for(f=h.data.length-1;f>=0;f--){var p=h.data[f][0]-m[0],
s=h.data[f][1]-m[1];h.data[f]=[p,s]}n.children.push(h)}else{h.end=k.end;h.start=k.start;m=h.data[0];n=h.anchors;p=[];for(f=h.data.length-1;f>=0;f--){s=h.data[f];for(al=n?n.length:0;al--;){var u=i.distSqrt(s,i.add(m,n[al]));p.push([u,al])}}p.count>0&&p.sort(function(t,q){return t[0]-q[0]});h.origin=m=n?i.add(m,n[0]):m;for(f=h.data.length-1;f>=0;f--){p=h.data[f][0]-m[0];s=h.data[f][1]-m[1];h.data[f]=[p,s]}}k.count++}this.render()}}};j.plugin(d,"Freehand")})();
(function(){function d(){this.started=!1}var j=require("Base");d.prototype={mousedown:function(b){var c=this.tool.liner;c.started=!0;c.mousemove.call(this,b)},mouseup:function(){},mousemove:function(b){var c=this.ctx;this.tool.liner.started&&this.render();var g=this.shapes[this.shapedata.count];if(g){var i=g.origin;if(i){g=g.data[g.data.length-1];c.moveTo(g[0]+i[0],g[1]+i[1]);c.lineTo(b._x,b._y);c.stroke()}}},end:function(){this.tool.liner.started=!1}};j.plugin(d)})();
(function(){function d(){this.attachto=null;this.started=!1;this.justclicked=!1;this.sample=b.sample;this.liner=new g}var j=require("Base"),b=require("CommonTools"),c=require("Shape"),g=require("Liner"),i=require("Vector"),l=b.anchorsUnderMouse,o=b.nearestAnchor;d.prototype={mousedown:function(a){var e=this.tool;e.liner.mousedown.call(this,a);if(!e.started){var f=o.call(this,a),k=new c(this.shapedata);if(f&&f[0]<30){e.attachto=f[1];k.origin=i.toVector(f[1])}else{e.attachto=null;k.origin=[a._x,a._y]}this.shapes[this.shapedata.count]=
k;e.started=!0}if(e.justclicked){e.liner.end.call(this,a);k=this.shapes[this.shapedata.count];if(k.data.length<1)delete this.shapes[this.shapedata.count];else{if(e.attachto){f=i.toVector(e.attachto);a=this.shapes[e.attachto[2]];i.sub(f,a.origin);k.data[0]=[0,0];a.children.push(k);k.parent=a}else this.shapedata.count++;e.started=!1}this.render()}else{(f=this.shapes[this.shapedata.count].origin)&&e.sample.call(this,{_x:a._x-f[0],_y:a._y-f[1]});e.justclicked=!0;setTimeout(function(){e.justclicked=!1},
250)}},mouseup:function(){},mousemove:function(a){l.call(this,a);this.tool.liner.mousemove.call(this,a)}};j.plugin(d,"Line")})();
(function(){Array.prototype.remove=function(d,j){var b=this.slice((j||d)+1||this.length);this.length=d<0?this.length+d:d;return this.push.apply(this,b)};CanvasRenderingContext2D.prototype.dashedLine=function(d,j,b,c,g){g==undefined&&(g=2);this.beginPath();this.moveTo(d,j);var i=b-d,l=c-j;g=Math.floor(Math.sqrt(i*i+l*l)/g);i/=g;l/=g;for(var o=0;o++<g;){d+=i;j+=l;this[o%2==0?"moveTo":"lineTo"](d,j)}this[o%2==0?"moveTo":"lineTo"](b,c);this.stroke();this.closePath()};CanvasRenderingContext2D.prototype.drawEllipse=
function(d,j,b,c){ox=b/2*0.5522848;oy=c/2*0.5522848;xe=d+b;ye=j+c;xm=d+b/2;ym=j+c/2;this.beginPath();this.moveTo(d,ym);this.bezierCurveTo(d,ym-oy,xm-ox,j,xm,j);this.bezierCurveTo(xm+ox,j,xe,ym-oy,xe,ym);this.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);this.bezierCurveTo(xm-ox,ye,d,ym+oy,d,ym);this.closePath();this.stroke()}})();
(function(){function d(a){function e(h){h=o.eventProcessor(h);f.canvasEvents.call(f,h)}var f=this,k=o.initCtx(a.canvas);this.grid=new j("Grid",a.gridsize||50);this.ctx=k[1];this.canvas=k[0];this.tool=this.receiver=null;this.tools={SingleTool:new c,Freehand:new g,Line:new i};this.shapes={};this.drawmode=!1;this.mousedown=!1;this.canvas.addEventListener("mousemove",e,!1);this.canvas.addEventListener("mousedown",e,!1);window.addEventListener("mouseup",e,!1)}require("Base");var j=require("Zone"),b=require("Vector"),
c=require("SingleTool"),g=require("Freehand"),i=require("Line");require("Shape");var l={},o={eventProcessor:function(a){if(a.layerX||a.layerX===0){a._x=a.layerX;a._y=a.layerY}else if(a.offsetX||a.offsetX===0){a._x=a.offsetX;a._y=a.offsetY}return a},stopEvent:function(a){if(a.stopPropagation)a.stopPropagation();else a.cancelBubble=!0},initCtx:function(a){a=document.getElementById(a);if(!a)throw"Error: I cannot find the canvas element!";a.onselectstart=function(){return!1};if(!a.getContext)throw"Error: no canvas.getContext!";
var e=a.getContext("2d");if(!e)throw"Error: failed to getContext!";return[a,e]}};d.prototype.select=function(){this.drawmode=!1};d.prototype.setTool=function(a,e,f){this.tool=a;this.shapedata.type=l[e];if(f)this.drawmode=!0};d.prototype.toggleControls=function(){this.shapedata.showcontrols=!this.shapedata.showcontrols;this.render()};d.prototype.drawControls=function(a){for(var e=this.shapedata.selectedcontrol?this.shapedata.selectedcontrol[1]:null,f=a.data,k=f.length,h=this.ctx;k--;){h.strokeStyle=
h.shadowColor="#aaa";if(k==e&&this.shapedata.selectedcontrol[0]==a.index)h.shadowColor=h.strokeStyle="#5fb";var m=b.add(f[k],a.origin);h.beginPath();h.arc(m[0],m[1],3,0,Math.PI*2,!0);h.closePath();h.stroke()}h.strokeStyle=h.shadowColor=a.parent?a.parent.strokeStyle:a.strokeStyle};d.prototype.render=function(){this.canvas.width=this.canvas.width;var a=this.shapes,e=this.ctx,f=this.shapedata.selected;this.grid.reset();e.lineWidth=2;e.shadowBlur=1;for(var k in a){var h=a[k];if(!h.parent){e.fillStyle=
h.fillStyle;e.strokeStyle=e.shadowColor=h.strokeStyle;e.shadowBlur=f&&h.index==f.index?9:1;h.type.draw.call(this,h);var m=!1,n=f&&h.index==f.index;if(this.shapedata.showcontrols&&n){this.drawControls(h);m=!0}for(n=h.children.length;n--;){var p=h.children[n];p.type.draw.call(this,p);m&&this.drawControls(p)}}this.grid.addShape(h)}this.grid.update()};d.prototype.shapedata={state:null,count:0,type:null,selected:null,selectedcontrol:null,showcontrols:!1};d.prototype.canvasEvents=function(a){if(!this.drawmode)return this.pick(a);
this.tool&&this.tool[a.type].call(this,a)};d.prototype.hasSelection=function(){return!!this.shapedata.selected};d.prototype.selectedShape=function(){return this.shapedata.selected};d.prototype.setColor=function(a,e){if(a){this.shapedata.strokeStyle=a;if(this.hasSelection())this.selectedShape().strokeStyle=a}if(e){this.shapedata.fillStyle=e;if(this.hasSelection())this.selectedShape().fillStyle=e}this.render()};d.prototype.shape=function(a){a.call(this)};d.prototype.prop=function(a,e){this.hasReceiver();
this.receiver[a]=e};d.prototype.name=function(a){l[a]={name:a};this.receiver=l[a]};d.prototype.done=function(){this.receiver=null};d.prototype.hasReceiver=function(){if(!this.receiver)throw Error("No shape active for configuration");return!!this.receiver};d.prototype.states=function(a){if(this.receiver.state)throw Error("States already set for this shape");this.receiver.states={};for(var e=a.length;e--;)this.receiver.states[a[e]]=e};d.prototype.color=function(a,e){this.hasReceiver();if(a)this.receiver.strokeStyle=
a;if(e)this.receiver.fillStyle=e};d.prototype.onCreate=function(a){this.hasReceiver();this.receiver.onCreate=a};d.prototype.anchors=function(a){this.hasReceiver();this.receiver.anchors=a};d.prototype.setDraw=function(a){this.hasReceiver();this.receiver.draw=a};d.prototype.removeSelected=function(){};d.prototype.pick=function(a){document.body.style.cursor="default";var e=this.shapes,f=this.shapedata,k=this.mousedown;if(a.type=="mousemove"&&!k){this.hover(a);if(!f.selected)return;var h=f.selected.data,
m=f.selected.origin,n=h.length,p=[];p.push(f.selected);p=p.concat(f.selected.children);for(var s=p.length,u=[a._x,a._y];s--;){var t=p[s];h=t.data;m=t.origin;for(n=h.length;n--;){var q=h[n];q=b.add(q,m);var r=b.distSqrt(u,q);if(r<10){f.selectedcontrol=t.parent?[t.index,n,t.parent.index]:[t.index,n,0];this.render();return}}}}if(a.type=="mousedown"){this.mousedown=!0;u=[a._x,a._y];k=this.grid.getClosest(u);m=!1;for(h=k?k.length:0;h--;){q=k[h];r=a._x-q[0];n=a._y-q[1];r=Math.sqrt(r*r+n*n);if(r<35){f.selected=
e[q[2]];if(f.selected.parent)f.selected=f.selected.parent;this.render();m=!0;break}}if(m)return;f.selected=f.selectedcontrol=null;this.render()}else if(a.type=="mousemove"&&!f.showcontrols&&k&&f.selected){e=[a._x,a._y];q=f.selected;if(q.parent)return;k=this.grid.getClosest([a._x,a._y]);r=!1;for(h=k?k.length:0;h--;)b.distSqrt(e,k[h])>50||(r=!0);if(!r)return;for(h=q.children.length;h--;){r=q.children[h];k=b.sub(q.origin,r.origin);r.origin=b.sub(e,k)}q.origin=e;this.render()}else if(a.type=="mousemove"&
f.showcontrols&&k&&f.selected&&f.selectedcontrol!=null){e=this.shapes[f.selectedcontrol[0]];if(f.selectedcontrol[1]>0){e.data[f.selectedcontrol[1]]=[a._x-e.origin[0],a._y-e.origin[1]];this.render()}}else this.mousedown=!1;f.selectedcontrol&&a.type=="mouseup"&&this.render()};d.prototype.hover=function(a){if(this.grid.getClosest([a._x,a._y]))document.body.style.cursor="pointer"};d.Vector=b;window.Squid=d})();
