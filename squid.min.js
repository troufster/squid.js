(function(){var d;d=window._G={Base:{noop:function(){},extend:function(k,a){k.prototype.__proto__=a.prototype;k.prototype.__super=a},plugin:function(k,a){if(!k.name&&!a)throw"Plugin must be named scope or have an id";d[a||k.name]=k},log:function(){typeof window.console!=="undefined"&&console.log([].slice.call(arguments).join("\t"))},keys:{N1:49,N2:50,N3:51,N4:52,N5:53,N6:54,N7:55,N8:56,T:84}}};window.require=function(k){var a=k.lastIndexOf("/"),b=k.substr(a+1,1);k=k.substr(a+2);b=b.toUpperCase()+
k;if(!d[b])throw"No such module"+b;return d[b]};window.module={exports:{}}})();(function(){function d(a,b){return[a,b]}var k=require("Base");d.sub=function(a,b){return[a[0]-b[0],a[1]-b[1]]};d.isVector=function(a){return a.length>1};d.toVector=function(a){return a.slice(0,2)};d.add=function(a,b){return[a[0]+b[0],a[1]+b[1]]};d.distSqrt=function(a,b){var g=[a[0]-b[0],a[1]-b[1]];return Math.sqrt(g[0]*g[0]+g[1]*g[1])};d.heading=function(a){return-Math.atan2(-a[1],a[0])};k.plugin(d)})();
(function(){function d(a,b){this.name=a;this.grid={};this.ent=[];this.cellSize=b}require("Vector");var k=require("Base");d.prototype._key=function(a){var b=this.cellSize;return Math.floor(a[1]/b)<<16^Math.floor(a[0]/b)};d.prototype._rawKey=function(a,b){var g=this.cellSize;return Math.floor(b/g)<<16^Math.floor(a/g)};d._fastKey=function(a,b,g){return Math.floor(b/g)<<16^Math.floor(a/g)};d.prototype.reset=function(){this.ent=[]};d.prototype.addShape=function(a){var b=a.data,g=b.length,h=a.origin;if(h){for(this.ent.push([h[0],
h[1],a.index,null]);g--;){var l=b[g];!l.length>1||this.ent.push([l[0]+h[0],l[1]+h[1],a.index,g])}for(g=(b=a.type.anchors)?b.length:0;g--;){l=b[g];this.ent.push([l[0]+h[0],l[1]+h[1],a.index,"anchor"])}}};d.prototype.addEntity=function(a,b){this.ent[a[2]]=a;b(null,a[2])};d.prototype.getEntity=function(a){return this.ent[a]};d.prototype.delEntity=function(a){delete this.ent[a]};d.prototype.getClosest=function(a){return this.grid[this._rawKey(a[0],a[1])]};d.prototype.getAreaKeys=function(a,b,g){(!a||
!b)&&g("No vector or distance supplied");var h=a[1]-b,l=a[0]+b,c=a[1]+b,e=this.cellSize,f=[],j=d._fastKey;for(a=a[0]-b;a<=l;a+=e)for(b=h;b<=c;b+=e){var i=j(a,b,e);f.push(i)}g(null,f)};d.prototype.getAreaIds=function(a,b,g){(!a||!b)&&g("No vector or distance supplied");var h=a[1]-b,l=a[0]+b,c=a[1]+b,e=this.cellSize,f=[],j=this.grid,i=d._fastKey;for(a=a[0]-b-1;a<=l+1;a+=e)for(b=h-1;b<=c+1;b+=e){var m=j[i(a,b,e)];if(m)for(var n=m.length;n--;){var o=m[n][2];f.indexOf(o)==-1&&f.push(o)}}g(null,f)};d.prototype.update=
function(){delete this.grid;this.grid={};for(var a=this.ent,b=this.grid,g=this.cellSize,h=d.addToGrid,l=a.length;l--;)h(a[l],b,g)};d.addToGrid=function(a,b,g){if(a&&b&&g){var h=a[0],l=a[1];co=[h-10,l-10,h+10,l-10,h-10,l+10,h+10,l+10];ec=[];rk=d._fastKey;for(h=0;h<8;h+=2){l=rk(co[h],co[h+1],g);if(ec.indexOf(l)==-1){ec.push(l);var c=b[l];c?c.push(a):b[l]=[a]}}}};k.plugin(d)})();
(function(){require("Base").plugin(function(d){this.type=d.type;this.index=d.count;this.data=[];this.origin=null;this.fillStyle=d.type.fillStyle;this.strokeStyle=d.type.strokeStyle;this.label="";this.state=d.state;this.children=[];this.parent=null})})();
(function(){function d(b){b=[b._x,b._y];this.tool.started||this.render();for(var g=this.grid.getClosest(b),h=g?g.length:0,l=[];h--;)if(g[h][3]=="anchor"){var c=a.distSqrt(g[h],b);l.push([c,g[h]])}return l.sort(function(e,f){return e[0]-f[0]})[0]}var k=require("Base"),a=require("Vector");k.plugin({anchorsUnderMouse:function(b){var g=this.tool,h=this.ctx;if((b=d.call(this,b))&&!g.started&&b[0]<30){g=b[1];h.beginPath();h.arc(g[0],g[1],3,0,Math.PI*2,!0);h.closePath();h.stroke()}},nearestAnchorVec:function(b){return d({_x:b[0],
_y:b[1]})},nearestAnchor:d,sample:function(b){var g=this.shapes,h=this.shapedata.count;g[h]&&g[h].data.push([b._x,b._y])}},"CommonTools")})();
(function(){function d(){this.started=!1}var k=require("Base");d.prototype={mousedown:function(a){var b=this.ctx;b.shadowBlur=1;b.strokeStyle="#000";b.lineWidth=2;b.beginPath();b.moveTo(a._x,a._y);this.tool.pencil.started=!0},mousemove:function(a){if(this.tool.pencil.started){var b=this.ctx;b.lineTo(a._x,a._y);b.stroke()}},mouseup:function(a){var b=this.tool.pencil;if(b.started){b.mousemove.call(this,a);b.started=!1}}};k.plugin(d)})();
(function(){function d(){}var k=require("Base"),a=require("Shape");d.prototype={mouseup:function(){},mousemove:function(){},mousedown:function(b){var g=new a(this.shapedata);g.origin=[b._x,b._y];this.shapes[this.shapedata.count]=g;this.shapedata.count++;this.render()}};k.plugin(d)})();
(function(){function d(){this.started=!1;this.samplenext=!0;this.sample=a.sample;this.pencil=new b}var k=require("Base"),a=require("CommonTools"),b=require("Pencil"),g=require("Shape"),h=require("Vector"),l=a.anchorsUnderMouse,c=a.nearestAnchor;d.prototype={mousemove:function(e,f){f=this.tool;l.call(this,e);f.pencil.mousemove.call(this,e);if(f.samplenext&&f.started){f.sample.call(this,e);f.samplenext=!1;setTimeout(function(){f.samplenext=!0},30)}},mousedown:function(e){tool=this.tool;tool.started=
!0;tool.pencil.mousedown.call(this,e);var f=this.shapedata;this.shapes[f.count]=new g(f);e=c.call(this,e);tool.attachto=e&&e[0]<30?e[1]:null},mouseup:function(e,f){f=this.tool;f.pencil.mouseup.call(this,e);var j=this.shapes,i=this.shapedata;f.sample.call(this,e);if(f.started){f.started=!1;var m=j[i.count];if(m.data.length<5)delete j[i.count];else{var n;if(f.attachto){n=h.toVector(f.attachto);var o=m.parent=j[f.attachto[2]];m.data[0]=m.origin=n;for(j=m.data.length-1;j>=0;j--){var r=m.data[j][0]-n[0],
s=m.data[j][1]-n[1];m.data[j]=[r,s]}o.children.push(m)}else{m.end=i.end;m.start=i.start;n=m.data[0];o=m.anchors;r=[];for(j=m.data.length-1;j>=0;j--){s=m.data[j];for(al=o?o.length:0;al--;){var t=h.distSqrt(s,h.add(n,o[al]));r.push([t,al])}}r.count>0&&r.sort(function(p,q){return p[0]-q[0]});m.origin=n=o?h.add(n,o[0]):n;for(j=m.data.length-1;j>=0;j--){r=m.data[j][0]-n[0];s=m.data[j][1]-n[1];m.data[j]=[r,s]}}i.count++}this.render()}}};k.plugin(d,"Freehand")})();
(function(){Array.prototype.remove=function(d,k){var a=this.slice((k||d)+1||this.length);this.length=d<0?this.length+d:d;return this.push.apply(this,a)};CanvasRenderingContext2D.prototype.dashedLine=function(d,k,a,b,g){g==undefined&&(g=2);this.beginPath();this.moveTo(d,k);var h=a-d,l=b-k;g=Math.floor(Math.sqrt(h*h+l*l)/g);h/=g;l/=g;for(var c=0;c++<g;){d+=h;k+=l;this[c%2==0?"moveTo":"lineTo"](d,k)}this[c%2==0?"moveTo":"lineTo"](a,b);this.stroke();this.closePath()};CanvasRenderingContext2D.prototype.drawEllipse=
function(d,k,a,b){ox=a/2*0.5522848;oy=b/2*0.5522848;xe=d+a;ye=k+b;xm=d+a/2;ym=k+b/2;this.beginPath();this.moveTo(d,ym);this.bezierCurveTo(d,ym-oy,xm-ox,k,xm,k);this.bezierCurveTo(xm+ox,k,xe,ym-oy,xe,ym);this.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);this.bezierCurveTo(xm-ox,ye,d,ym+oy,d,ym);this.closePath();this.stroke()}})();
(function(){function d(c){function e(i){i=l.eventProcessor(i);f.canvasEvents.call(f,i)}var f=this,j=l.initCtx(c.canvas);this.grid=new k("Grid",c.gridsize||50);this.ctx=j[1];this.canvas=j[0];this.tool=this.receiver=null;this.tools={SingleTool:new b,Freehand:new g};this.shapes={};this.drawmode=!1;this.mousedown=!1;this.canvas.addEventListener("mousemove",e,!1);this.canvas.addEventListener("mousedown",e,!1);window.addEventListener("mouseup",e,!1)}require("Base");var k=require("Zone"),a=require("Vector"),
b=require("SingleTool"),g=require("Freehand");require("Shape");var h={},l={eventProcessor:function(c){if(c.layerX||c.layerX===0){c._x=c.layerX;c._y=c.layerY}else if(c.offsetX||c.offsetX===0){c._x=c.offsetX;c._y=c.offsetY}return c},stopEvent:function(c){if(c.stopPropagation)c.stopPropagation();else c.cancelBubble=!0},initCtx:function(c){c=document.getElementById(c);if(!c)throw"Error: I cannot find the canvas element!";c.onselectstart=function(){return!1};if(!c.getContext)throw"Error: no canvas.getContext!";
var e=canvas.getContext("2d");if(!e)throw"Error: failed to getContext!";return[c,e]}};d.prototype.select=function(){this.drawmode=!1};d.prototype.setTool=function(c,e,f){this.tool=c;this.shapedata.type=h[e];if(f)this.drawmode=!0};d.prototype.toggleControls=function(){this.shapedata.showcontrols=!this.shapedata.showcontrols;this.render()};d.prototype.drawControls=function(c){for(var e=this.shapedata.selectedcontrol?this.shapedata.selectedcontrol[1]:null,f=c.data,j=f.length,i=this.ctx;j--;){i.strokeStyle=
i.shadowColor="#aaa";if(j==e&&this.shapedata.selectedcontrol[0]==c.index)i.shadowColor=i.strokeStyle="#5fb";var m=a.add(f[j],c.origin);i.beginPath();i.arc(m[0],m[1],3,0,Math.PI*2,!0);i.closePath();i.stroke()}i.strokeStyle=i.shadowColor=c.parent?c.parent.strokeStyle:c.strokeStyle};d.prototype.render=function(){this.canvas.width=this.canvas.width;var c=this.shapes,e=this.ctx,f=this.shapedata.selected;this.grid.reset();e.lineWidth=2;e.shadowBlur=1;for(var j in c){var i=c[j];if(!i.parent){e.fillStyle=
i.fillStyle;e.strokeStyle=e.shadowColor=i.strokeStyle;e.shadowBlur=f&&i.index==f.index?9:1;i.type.draw.call(this,i);var m=!1,n=f&&i.index==f.index;if(this.shapedata.showcontrols&&n){this.drawControls(i);m=!0}for(n=i.children.length;n--;){var o=i.children[n];o.type.draw.call(this,o);m&&this.drawControls(o)}}this.grid.addShape(i)}this.grid.update()};d.prototype.shapedata={state:null,count:0,type:null,selected:null,selectedcontrol:null,showcontrols:!1};d.prototype.canvasEvents=function(c){if(!this.drawmode)return this.pick(c);
this.tool&&this.tool[c.type].call(this,c)};d.prototype.hasSelection=function(){return!!this.shapedata.selected};d.prototype.selectedShape=function(){return this.shapedata.selected};d.prototype.setColor=function(c,e){if(c){this.shapedata.strokeStyle=c;if(this.hasSelection())this.selectedShape().strokeStyle=c}if(e){this.shapedata.fillStyle=e;if(this.hasSelection())this.selectedShape().fillStyle=e}this.render()};d.prototype.shape=function(c){c.call(this)};d.prototype.prop=function(c,e){this.hasReceiver();
this.receiver[c]=e};d.prototype.name=function(c){h[c]={name:c};this.receiver=h[c]};d.prototype.done=function(){this.receiver=null};d.prototype.hasReceiver=function(){if(!this.receiver)throw Error("No shape active for configuration");return!!this.receiver};d.prototype.states=function(c){if(this.receiver.state)throw Error("States already set for this shape");this.receiver.states={};for(var e=c.length;e--;)this.receiver.states[c[e]]=e};d.prototype.color=function(c,e){this.hasReceiver();if(c)this.receiver.strokeStyle=
c;if(e)this.receiver.fillStyle=e};d.prototype.anchors=function(c){this.hasReceiver();this.receiver.anchors=c};d.prototype.draw=function(c){this.hasReceiver();this.receiver.draw=c};d.prototype.pick=function(c){document.body.style.cursor="default";var e=this.shapes,f=this.shapedata,j=this.mousedown;if(c.type=="mousemove"&&!j){this.hover(c);if(!f.selected)return;var i=f.selected.data,m=f.selected.origin,n=i.length,o=[];o.push(f.selected);o=o.concat(f.selected.children);for(var r=o.length,s=[c._x,c._y];r--;){var t=
o[r];i=t.data;m=t.origin;for(n=i.length;n--;){var p=i[n];p=a.add(p,m);var q=a.distSqrt(s,p);if(q<10){f.selectedcontrol=[t.index,n,t.parent.index];this.render();return}}}}if(c.type=="mousedown"){this.mousedown=!0;i=this.grid.getClosest([c._x,c._y]);m=!1;for(j=i?i.length:0;j--;){p=i[j];q=c._x-p[0];n=c._y-p[1];q=Math.sqrt(q*q+n*n);if(q<35){f.selected=e[p[2]];if(f.selected.parent)f.selected=f.selected.parent;this.render();m=!0;break}}if(m)return;f.selected=f.selectedcontrol=null;this.render()}else if(c.type==
"mousemove"&&!f.showcontrols&&j&&f.selected){e=[c._x,c._y];p=f.selected;if(p.parent)return;if(a.distSqrt(e,p.origin)>50)return;for(j=p.children.length;j--;){q=p.children[j];i=a.sub(p.origin,q.origin);q.origin=a.sub(e,i)}p.origin=e;this.render()}else if(c.type=="mousemove"&f.showcontrols&&j&&f.selected&&f.selectedcontrol!=null){e=this.shapes[f.selectedcontrol[0]];if(f.selectedcontrol[1]>0){e.data[f.selectedcontrol[1]]=[c._x-e.origin[0],c._y-e.origin[1]];this.render()}}else this.mousedown=!1;f.selectedcontrol&&
c.type=="mouseup"&&this.render()};d.prototype.hover=function(c){if(this.grid.getClosest([c._x,c._y]))document.body.style.cursor="pointer"};d.Vector=a;window.Squid=d})();
